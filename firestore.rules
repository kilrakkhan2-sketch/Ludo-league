
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Check both custom claim and Firestore document for admin status.
    // This provides robustness. Claim is fast, doc is source of truth.
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
      );
    }

    // ========= ADMIN RULE: Global Access =========
    // This rule MUST come first. It grants admins god-mode access.
    // If a user is an admin, no other rules below will block them.
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // ========= Rules for Non-Admin Users =========
    // These rules are evaluated only if the user is NOT an admin.

    // --- User Profiles ---
    match /users/{userId} {
      // Any authenticated user can read public profile data (for leaderboards, match info, etc).
      allow get, list: if request.auth != null;
      // A user can only create or update their own profile.
      // They cannot change their own balance or admin status.
      allow create, update: if isOwner(userId) &&
                             !('walletBalance' in request.resource.data) &&
                             !('isAdmin' in request.resource.data);
    }

    // --- KYC ---
    match /kycApplications/{kycId} {
      // A user can create their own application.
      allow create: if isOwner(request.resource.data.userId);
      // A user can only read their own application status.
      allow get: if isOwner(resource.data.userId);
    }

    // --- Matches ---
    match /matches/{matchId} {
      // Any authenticated user can view a match or list matches (for the lobby).
      allow get, list: if request.auth != null;
      // A user can create a match if they are the creator listed in the document.
      allow create: if isOwner(request.resource.data.creatorId);
      // ANY authenticated user can update (join) a match IF it's in 'waiting' status.
      // The Cloud Function transaction will handle the logic for fees and player limits.
      allow update: if request.auth != null && resource.data.status == 'waiting';
    }

    match /matches/{matchId}/results/{resultId} {
      // Any authenticated user can read match results for transparency.
      allow read: if request.auth != null;
      // A user can only submit (write) their own result. `resultId` should be the user's UID.
      allow write: if isOwner(resultId);
    }

    // --- Transactions ---
    match /transactions/{transactionId} {
      // Users can only create specific, safe transaction types.
      // 'winnings', 'refund', 'deposit' are handled by backend functions.
      // Users can only initiate entry-fee or withdrawal-request related transactions via client.
      allow create: if isOwner(request.resource.data.userId) &&
                     (request.resource.data.type == 'entry-fee' || request.resource.data.type == 'admin-credit' || request.resource.data.type == 'admin-debit');
      // A user can only read their own transaction history.
      allow read: if isOwner(resource.data.userId) ||
                    (request.query.get("where") != null && request.query.get("where")[0][2] == request.auth.uid);
    }

    // --- Deposit and Withdrawal Requests ---
    // Users create these, but cannot read/list them after creation. Only admins can.
    match /depositRequests/{depositId} {
        allow create: if isOwner(request.resource.data.userId);
    }
     match /withdrawalRequests/{withdrawalId} {
        allow create: if isOwner(request.resource.data.userId);
    }

    // --- Read-only data for all authenticated users ---
    match /tournaments/{doc=**} { allow get, list: if request.auth != null; }
    match /news/{doc=**} { allow get, list: if request.auth != null; }
    match /upiConfiguration/active { allow get: if request.auth != null; }
    match /referralConfiguration/settings { allow get: if request.auth != null; }

    // --- Admin-only collections (already covered by global admin rule) ---
    // Explicitly deny client access for clarity and safety.
    match /adminLogs/{logId} {
      allow read, write: if false;
    }
  }
}
