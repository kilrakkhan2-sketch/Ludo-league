
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for isAdmin flag in the user's document in the /users collection.
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ========= User Profile Rules =========
    match /users/{userId} {
      // Admins can read/write any user profile.
      allow read, write: if isAdmin();
      // Users can get their own profile.
      allow get: if isOwner(userId);
       // Users can list all users (e.g., for leaderboards).
      allow list: if request.auth != null;
      // Users can create or update their own profile.
      allow create, update: if isOwner(userId);
    }
    
    // ========= KYC Application Rules =========
    match /kycApplications/{kycId} {
      // Admins can read/write any application.
      allow read, write: if isAdmin();
      // Users can create and view their own application.
      allow create, get: if isOwner(request.resource.data.userId);
    }

    // ========= Match Rules =========
    match /matches/{matchId} {
      // Admins can manage all matches.
      allow read, write: if isAdmin();
      // Any authenticated user can view matches for the lobby.
      allow get, list: if request.auth != null;
      // A user can create a match for themselves.
      allow create: if isOwner(request.resource.data.creatorId);
      // Allow a user to join a match ('waiting' status) or update it if they are already a player.
      allow update: if request.auth != null && (
                      // Case 1: Joining a match that is waiting for players.
                      (resource.data.status == 'waiting' &&
                       request.resource.data.playerIds.hasAll(resource.data.playerIds) && // cannot remove players
                       request.resource.data.playerIds.size() == resource.data.playerIds.size() + 1 && // only one player added
                       request.resource.data.playerIds.hasAny([request.auth.uid]) // the player being added must be the current user
                      ) ||
                      // Case 2: Already a player in the match.
                      (request.auth.uid in resource.data.playerIds)
                    );
    }
    
    // Match Results Sub-collection
    match /matches/{matchId}/results/{userId} {
      // Admins can manage results.
      allow read, write: if isAdmin();
      // Any authenticated user can read results for transparency.
      allow get, list: if request.auth != null;
      // A user can only write their own result.
      allow create, update: if isOwner(userId);
    }

    // ========= Transaction Rules =========
    match /transactions/{transactionId} {
      // Admins can read/write any transaction.
      allow read, write: if isAdmin();
      // A user can ONLY read their own transactions.
      allow get, list: if request.auth != null && resource.data.userId == request.auth.uid;
      // A user can only create a transaction for themselves.
      allow create: if isOwner(request.resource.data.userId);
    }

    // ========= Admin-Only Writable Collections =========
    match /depositRequests/{depositId} {
        allow read, write: if isAdmin();
    }
    match /withdrawalRequests/{withdrawalId} {
        allow read, write: if isAdmin();
    }
     match /adminLogs/{logId} {
        allow read, write: if isAdmin();
    }
    
    // ========= Public/Read-Only Collections for Users =========
    match /tournaments/{tournamentId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /tournaments/{tournamentId}/matches/{matchId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    match /upiConfiguration/active {
      allow get: if request.auth != null;
      allow write: if isAdmin();
    }
    match /referralConfiguration/settings {
      allow get: if request.auth != null;
      allow write: if isAdmin();
    }
    match /news/{newsId} {
        allow get: if request.auth != null;
        allow write: if isAdmin();
    }
  }
}
