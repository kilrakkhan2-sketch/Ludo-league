rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isSuperAdmin() {
      return getRole() == 'superadmin';
    }
    
    function isMatchAdmin() {
      return getRole() in ['superadmin', 'match_admin'];
    }
    
    function isWithdrawalAdmin() {
      return getRole() in ['superadmin', 'withdrawal_admin'];
    }
    
    function isDepositAdmin() {
      return getRole() in ['superadmin', 'deposit_admin'];
    }

    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if !isSignedIn() || isOwner(userId); // Allow creating user doc on signup or if user doesn't have one yet
      allow update: if isOwner(userId); // Users can only update their own profile
      
      // Personal notifications and transactions are subcollections
      match /personal_notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
      match /transactions/{transactionId} {
        allow read: if isOwner(userId) || isSuperAdmin();
        allow create: if false; // Transactions created by server/rules only
      }
    }

    // Publicly readable, admin-writable settings
    match /settings/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    // UPI accounts for deposits, admin-managed
    match /upi-accounts/{accountId} {
       allow read, list: if isDepositAdmin() || isSuperAdmin();
       allow create, update, delete: if isDepositAdmin() || isSuperAdmin();
    }

    // Deposit and withdrawal requests
    match /deposit-requests/{requestId} {
      allow read, list: if isDepositAdmin() || isSuperAdmin() || (isOwner(resource.data.userId) && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isDepositAdmin() || isSuperAdmin();
    }
    
    match /withdrawal-requests/{requestId} {
      allow read, list: if isWithdrawalAdmin() || isSuperAdmin() || isOwner(resource.data.userId);
      allow create: if isSignedIn();
      allow update: if isWithdrawalAdmin() || isSuperAdmin();
    }

    // Matches
    match /matches/{matchId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn();
      
      allow update: if isSignedIn() && (
                      // Player joining (not filling the match)
                      (
                        resource.data.status == 'open' &&
                        request.resource.data.players == resource.data.players + [request.auth.uid] &&
                        resource.data.players.size() < resource.data.maxPlayers - 1 &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.walletBalance >= resource.data.entryFee &&
                        request.resource.data.diff(resource.data).affectedKeys().size() == 1 &&
                        request.resource.data.diff(resource.data).affectedKeys().has('players')
                      ) ||
                      // Player joining and filling the match
                      (
                        resource.data.status == 'open' &&
                        request.resource.data.players == resource.data.players + [request.auth.uid] &&
                        resource.data.players.size() == resource.data.maxPlayers - 1 &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.walletBalance >= resource.data.entryFee &&
                        request.resource.data.diff(resource.data).affectedKeys().size() == 2 &&
                        request.resource.data.diff(resource.data).affectedKeys().hasAll(['players', 'status']) &&
                        request.resource.data.status == 'ongoing'
                      ) ||
                      // Creator updating room code
                      (
                        request.auth.uid == resource.data.creatorId &&
                        resource.data.status == 'ongoing' &&
                        request.resource.data.diff(resource.data).affectedKeys().size() == 1 &&
                        request.resource.data.diff(resource.data).affectedKeys().has('roomCode')
                      ) ||
                      // Admin managing the match state
                      (
                        isMatchAdmin()
                      )
                    );
      
      // Results and Chat subcollections
      match /results/{userId} {
        allow read: if isSignedIn();
        // Allow write if user is part of the match's player list
        allow create, update: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.players;
      }
      match /chat/{messageId} {
        allow read: if isSignedIn();
        // Allow write if user is part of the match's player list
        allow create: if request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.players;
      }
    }
    
    // Tournaments - readable by all, writable by admins
    match /tournaments/{tournamentId} {
        allow read: if true;
        allow create, update, delete: if isMatchAdmin();
        
        match /players/{userId} {
            allow read: if true;
            allow create: if isSignedIn(); // Add rules for entry fee etc.
            allow delete: if isOwner(userId) || isMatchAdmin();
        }
        
        match /rounds/{roundId} {
            allow read: if true;
            allow create, update, delete: if isMatchAdmin();
        }
    }
    
    // KYC documents - only accessible by user and superadmin
    match /kyc-requests/{kycId} {
      allow read: if isOwner(resource.data.userId) || isSuperAdmin();
      allow create: if isSignedIn();
      allow update: if isSuperAdmin(); // Only admins can change status
    }
    
    // Announcements - readable by all, writable by superadmins
    match /announcements/{announcementId} {
      allow read: if true;
      allow create, update, delete: if isSuperAdmin();
    }
  }
}