
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for the 'isAdmin' custom claim. This is the most secure and efficient method.
      return request.auth != null && request.auth.token.isAdmin == true;
    }

    // ========= ADMIN RULE: Global Access =========
    // Admins have unrestricted read/write access to the entire database.
    // This rule is checked first and grants access if true, preventing any further restrictive rules from blocking admins.
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ========= User Profiles =========
    match /users/{userId} {
      // Users can read their own profile, and other users can read non-sensitive public info.
      allow get: if request.auth != null;
      // Users can only create and update their own profile.
      allow create, update: if isOwner(userId);
      // Deletion of user accounts should be handled by a backend process or admin action.
      allow delete: if isAdmin(); 
    }

    // ========= Transactions (Deposits/Withdrawals) =========
    match /transactions/{transactionId} {
        // Users can create their own transactions.
        allow create: if isOwner(request.resource.data.userId);
        // Users can read their own transactions. Admins can read all.
        allow get: if isOwner(get(/databases/$(database)/documents/transactions/$(transactionId)).data.userId) || isAdmin();
        // The status of a transaction is updated by admins or backend functions.
        // Users should not be able to update their own transaction status.
        allow update: if isAdmin();
    }

    // ========= KYC Applications =========
    match /kycApplications/{kycId} {
      // Users can create their own KYC application.
      allow create: if isOwner(request.resource.data.userId);
      // Users can read their own KYC status. Admins can read all.
      allow get: if isOwner(get(/databases/$(database)/documents/kycApplications/$(kycId)).data.userId) || isAdmin();
      // KYC status is updated by admins.
      allow update: if isAdmin();
    }

    // ========= Admin Logs =========
    // Only admins can write to or read admin logs for security auditing.
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // ========= App Settings (e.g., UPI ID for payments) =========
    match /settings/{settingId} {
      // All authenticated users can read general settings.
      allow get: if request.auth != null;
      // Only admins can change the settings.
      allow write: if isAdmin();
    }
  }
}
