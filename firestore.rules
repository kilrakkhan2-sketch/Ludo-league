
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.isAdmin == true;
    }

    // ========= User Profiles =========
    match /users/{userId} {
      // Any authenticated user can view a user's public profile.
      allow get: if request.auth != null;
      // Users can only list their own data (though this is not a common use case).
      allow list: if request.auth != null && request.query.resource.data.userId == request.auth.uid;
      // Users can only create and update their own profile.
      allow create, update: if isOwner(userId);
      // Only admins can delete user accounts.
      allow delete: if isAdmin(); 
    }
    
    // ========= Matches Collection =========
    match /matches/{matchId} {
      // A user can get a specific match if they are a player in it, or if they are an admin.
      allow get: if isAdmin() || (request.auth.uid in resource.data.players);
      // Any authenticated user can query the matches collection.
      // Security is enforced by the client-side query (e.g., where('players', 'array-contains', uid)).
      allow list: if request.auth != null;
      
      // A user can create a match, and their ID is stored as the creator.
      allow create: if isOwner(request.resource.data.creatorId);
      
      // A player in the match can update it, or an admin can.
      allow update: if isAdmin() || (request.auth.uid in resource.data.players);
      
      // Only admins can delete a match.
      allow delete: if isAdmin();
    }

    // ========= Tournaments Collection =========
    match /tournaments/{tournamentId} {
      // ANY user, authenticated or not, can view tournaments.
      allow get, list: if true;
      // Only admins can create, update, or delete tournaments.
      allow write: if isAdmin();
    }

    // ========= Transactions (Deposits/Withdrawals) =========
    match /transactions/{transactionId} {
        allow create: if isOwner(request.resource.data.userId);
        // A user can get their own transaction. Admins can get any.
        allow get: if isAdmin() || isOwner(get(/databases/$(database)/documents/transactions/$(transactionId)).data.userId);
        // Users should only be able to list their own transactions.
        allow list: if isAdmin() || (request.auth != null && request.query.resource.data.userId == request.auth.uid);
        allow update: if isAdmin();
    }

    // ========= KYC Applications =========
    match /kycApplications/{kycId} {
      allow create: if isOwner(request.resource.data.userId);
      allow get: if isAdmin() || isOwner(get(/databases/$(database)/documents/kycApplications/$(kycId)).data.userId);
      allow list: if isAdmin() || (request.auth != null && request.query.resource.data.userId == request.auth.uid);
      allow update: if isAdmin();
    }

    // ========= Admin-Only Collections =========
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    match /news/{newsId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    match /banners/{bannerId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    match /settings/{settingId} {
      allow get: if true;
      allow write: if isAdmin();
    }
  }
}
