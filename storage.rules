
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isDepositOrSuperAdmin() {
      let role = getUserRole();
      return role == 'deposit_admin' || role == 'superadmin';
    }

    // User profile images
    match /profile-images/{userId}/{imageName} {
      allow read: if request.auth != null;
      allow write: if isOwner(userId);
      allow delete: if false; // Prevent deletion
    }
    
    // Deposit screenshots
    match /deposit-screenshots/{userId}/{imageName} {
      allow read: if isOwner(userId) || isDepositOrSuperAdmin();
      allow write: if isOwner(userId);
      allow delete: if false;
    }
    
    // Result screenshots
    match /match-results/{matchId}/{fileName} {
      // Allow read by players in the match or match/super admins
      allow read: if request.auth != null && (get(/databases/$(database)/documents/matches/$(matchId)).data.players.hasAny([request.auth.uid]) || getUserRole() == 'match_admin' || getUserRole() == 'superadmin');
      // Allow write only by players of that match
      allow write: if request.auth != null && get(/databases/$(database)/documents/matches/$(matchId)).data.players.hasAny([request.auth.uid]);
      allow delete: if false;
    }

    // KYC Documents
    match /kyc-documents/{userId}/{fileName} {
      allow read: if isOwner(userId) || isDepositOrSuperAdmin();
      allow write: if isOwner(userId);
      allow delete: if false;
    }
    
    // Admin uploads
    match /admin/{fileName} {
      allow read: if request.auth != null;
      allow write: if getUserRole() == 'superadmin';
    }
  }
}
