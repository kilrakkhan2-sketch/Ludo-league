rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ========= ADMIN RULE: Global Access =========
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // ========= Rules for Non-Admin Users =========

    match /users/{userId} {
      // User can write to their own doc.
      allow create, update: if isOwner(userId);
      // Any authenticated user can read any other user's profile (for leaderboards, etc).
      allow read: if request.auth != null;
    }

    match /kycApplications/{kycId} {
      allow create: if isOwner(request.resource.data.userId);
      allow get: if isOwner(resource.data.userId);
    }

    match /matches/{matchId} {
      // Non-admins can read a match if they are a player OR if the match is waiting.
      // This covers both queries on the lobby page.
      allow read: if request.auth != null && (request.auth.uid in resource.data.playerIds || resource.data.status == 'waiting');

      allow create: if isOwner(request.resource.data.creatorId);
      
      // Allow joining a match or updating it if user is a player.
      allow update: if request.auth != null && (resource.data.status == 'waiting' || request.auth.uid in resource.data.playerIds);
    }

    match /matches/{matchId}/results/{userId} {
      allow read: if request.auth != null;
      allow write: if isOwner(request.resource.data.userId);
    }

    // Rules for user-specific data collections
    match /transactions/{docId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      // Allow user to query their own transactions
      allow list: if request.auth.uid == request.query.filters.userId;
    }
    
    match /depositRequests/{docId} {
        allow read: if isOwner(resource.data.userId);
        allow create: if isOwner(request.resource.data.userId);
        // Allow user to query their own deposit requests
        allow list: if request.auth.uid == request.query.filters.userId;
    }
    
    match /withdrawalRequests/{docId} {
        allow read: if isOwner(resource.data.userId);
        allow create: if isOwner(request.resource.data.userId);
        // Allow user to query their own withdrawal requests
        allow list: if request.auth.uid == request.query.filters.userId;
    }

    // Read-only collections for clients.
    match /tournaments/{doc=**} { allow read: if request.auth != null; }
    match /news/{doc=**} { allow read: if request.auth != null; }
    match /upiConfiguration/active { allow read: if request.auth != null; }
    match /referralConfiguration/settings { allow get: if request.auth != null; }

    // Admin-only collections (clients can't read or write).
    match /adminLogs/{l=**} { allow read, write: if false; }
  }
}
