
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ========= ADMIN RULE: Global Access =========
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // ========= Rules for Non-Admin Users =========

    match /users/{userId} {
      allow create, update: if isOwner(userId);
      allow read: if request.auth != null;
    }
    
    match /matchmakingQueue/{userId} {
      // User can only create, read, or delete their own entry in the queue.
      allow read, create, delete: if isOwner(userId);
      // User cannot update their entry once in queue.
      allow update: if false;
    }

    match /kycApplications/{kycId} {
      allow create: if isOwner(request.resource.data.userId);
      allow get: if isOwner(resource.data.userId);
    }

    match /matches/{matchId} {
      // Any authenticated user can read a match document, vital for lobby.
      allow read: if request.auth != null;
      // Nobody except admin can create a match directly, it is handled by cloud function.
      allow create: if false;
      // Only players involved in the match can update it (e.g. submitting room code)
      allow update: if request.auth != null && request.auth.uid in resource.data.playerIds;
    }

    match /matches/{matchId}/results/{userId} {
      allow read: if request.auth != null;
      // Allow a user to write to their own result document.
      allow write: if isOwner(request.resource.data.userId);
    }

    match /transactions/{docId} {
      allow read: if isOwner(resource.data.userId);
      // Transactions can only be created by server-side logic (Cloud Functions)
      allow create: if false; 
      allow list: if request.auth.uid == request.query.filters.userId;
    }
    
    match /depositRequests/{docId} {
        allow read: if isOwner(resource.data.userId);
        allow create: if isOwner(request.resource.data.userId);
        allow list: if request.auth.uid == request.query.filters.userId;
    }
    
    match /withdrawalRequests/{docId} {
        allow read: if isOwner(resource.data.userId);
        allow create: if isOwner(request.resource.data.userId);
        allow list: if request.auth.uid == request.query.filters.userId;
    }

    // Rules for Support Chat
    match /supportChats/{userId}/messages/{messageId} {
      allow read, write: if isOwner(userId);
    }

    // Read-only collections for clients.
    match /tournaments/{doc=**} { allow read: if request.auth != null; }
    match /news/{doc=**} { allow read: if request.auth != null; }
    match /upiConfiguration/active { allow read: if request.auth != null; }
    match /referralConfiguration/settings { allow get: if request.auth != null; }

    // Admin-only collections (clients can't read or write).
    match /adminLogs/{l=**} { allow read, write: if false; }
  }
}
