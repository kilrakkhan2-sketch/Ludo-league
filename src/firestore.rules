rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isPlayer(matchId) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/matches/$(matchId)) &&
             request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.players;
    }

    // --- Collection Rules ---

    // Users Collection
    match /users/{userId} {
      // Admins can read any user profile.
      allow read: if isAdmin();
      // A user can get their own profile.
      allow get: if isOwner(userId);
      // A user can update their own profile, an admin can update any.
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // KYC Applications Collection
    match /kycApplications/{applicationId} {
      // Admins have full access.
      allow read, write: if isAdmin();
      // Users can read their own application.
      allow read: if isOwner(get(/databases/$(database)/documents/kycApplications/$(applicationId)).data.userId);
      // Users can create their own application.
      allow create: if isOwner(request.resource.data.userId);
    }
    
    // Matches Collection
    match /matches/{matchId} {
      // Any authenticated user can read match details.
      allow read: if request.auth != null;
      // The creator can create a match.
      allow create: if isOwner(request.resource.data.creatorId);
      // Only players in the match or admins can update it.
      allow update: if isPlayer(matchId) || isAdmin();
      // Only admins can delete a match.
      allow delete: if isAdmin();
    }

    // Match Results Sub-collection
    match /matches/{matchId}/results/{userId} {
      // Admins have full write access
      allow write: if isAdmin();
      // Any authenticated user can read results.
      allow read: if request.auth != null;
      // Only the specific user can submit/update their own result.
      allow create, update: if isOwner(userId);
    }

    // Transactions Collection
    match /transactions/{transactionId} {
      // Admins have full access.
      allow read, write: if isAdmin();
      // Users can read their own transactions.
      allow read: if isOwner(get(/databases/$(database)/documents/transactions/$(transactionId)).data.userId);
      // Users can create their own transactions (e.g., for deposits).
      allow create: if isOwner(request.resource.data.userId);
    }

    // Deposit Requests (Admin-only management for read/write)
    match /depositRequests/{depositId} {
      // Admins have full read/write access.
      allow read, write: if isAdmin();
      // Users can create their own deposit requests.
      allow create: if isOwner(request.resource.data.userId);
    }
    
    // Withdrawal Requests (Admin-only management for read/write)
    match /withdrawalRequests/{withdrawalId} {
       // Admins have full read/write access.
       allow read, write: if isAdmin();
       // Users can create their own withdrawal requests.
       allow create: if isOwner(request.resource.data.userId);
    }

    // Admin Logs (Admin-only)
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // Tournaments Collection
    match /tournaments/{tournamentId} {
      // Any authenticated user can view tournaments.
      allow read: if request.auth != null;
      // Only admins can create, update, or delete tournaments.
      allow write: if isAdmin();
    }
    
    // Tournament Matches Sub-collection
    match /tournaments/{tournamentId}/matches/{matchId} {
       // Authenticated users can view matches within a tournament.
       allow read: if request.auth != null;
       // Only admins can manage these matches.
       allow write: if isAdmin();
    }
    
    // --- Configuration Collections (Admin write, User read) ---
    match /upiConfiguration/active {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /referralConfiguration/settings {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /news/{newsId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
